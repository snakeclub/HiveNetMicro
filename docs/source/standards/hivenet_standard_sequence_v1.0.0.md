

# HiveNet流水号规范

规范英文名：HiveNet Sequence Standards

规范中文名：HiveNet 流水号规范

**HiveNet标识名：hivenet_sequence_standards**

**HiveNet版本：v1.0.0**



## 制定规范目的

随着分布式架构的扩大，系统间、微服务间的接口交互将越来越多，调用链路也会越来越复杂。为了统一接口交互的标准，简化调用复杂度，以及保障分布式事务一致性，需制定统一的接口交互流水号规范。

注：该流水号规范仅针对接口交互，并未涵盖任务序号、业务编号等的系统内部使用其他流水号。



## 流水号分类

接口交互涉及的流水号分为三种，定义如下：

**（1） 统一流水号**

由第一个发起交易的系统或微服务生成，用于在所有系统及微服务的接口处理中唯一标识一笔交易处理过程。统一流水号通常由前端交易渠道系统或微服务生成，被调用的系统或微服务在处理请求时需记录前端传入的统一流水号，如在请求处理时需使用其他系统或微服务的接口，则需继续使用该统一流水号进行调用。

统一流水号可以贯穿一笔前端交易的全部接口调用，因此可以通过统一流水号找到处理全过程的所有接口调用记录，便于查找实际的交易处理链路，所起的作用与微服务的调用链类似。

注：统一流水号的传递机制并不能保证在单个系统中的唯一性（例如系统自己调用了自己的接口，则该统一流水号在系统内会有两笔调用记录），因此请不要将作为交易唯一标识使用，也不能作为交易重复的判断依据。

**（2） 系统流水号**

由当前处理交易的系统或微服务生成，用于在当前系统中唯一标识业务处理过程的某个需接口交互步骤，如需后端接口支持交易重复的控制，则应在多次接口调用（例如失败重调）继续使用第一次生成的系统流水号进行处理。

例如一笔交易业务处理需按顺序执行汇款发报、内部户记账、客户记账这3个接口调用，则应为每个交互步骤生成系统流水号S1、S2、S3，如果在内部户记账失败需要重新调用接口时，应继续使用S2作为系统流水号送入接口，使后端系统可以根据S2判断交易是否存在重复的问题。

注：系统流水号对应的是处理步骤而不是交易本身，在系统中一笔交易可能会产生多个系统流水号。

**（3） 接口流水号**

由接口调用方系统或微服务生成，用于唯一标识当次的接口交互，每一次接口调用均可生成一个新的接口流水号。

接口提供方应实现接口流水号的重复判断机制，如发现接口流水号重复的情况，直接可视为接口重复调用拒绝交易，以此保障网络底层出现问题的情况下不会造成重复交易处理。



## 统一流水号规则

统一流水号共计28位，生成规则为“5位系统标识+3位模块标识+2位服务器实例序号+8位日期+10位序号”，说明如下：

**系统标识：**为5位字符（数字或英文字母），部门内每个产品系统均应定义一个唯一的系统标识。

**模块标识：**为3位字符（数字或英文字母），用于标识某个产品系统内部的模块，具体模块的标识定义由该产品系统的研发团队负责管理。

**服务器实例序号：**集群服务器具体实例号，比如柜面有三台服务器集群，分别为01,02,03，则第一台机器生成的实例号为01。

**日期：**交易或具体业务在该前端渠道系统实际的发起日期，为YYYYMMDD格式的日期编码。例如20150810。

**序号：**标识当日前端渠道系统发起业务的顺序号，每日从0000000001开始。如0000001234。

 

样例说明：

A系统（假设系统标识为C0001）通过PC端界面（假设模块标识为A01）在2015年7月10日发起一笔业务，所处理的服务器实例编号为01,依据统一流水号生成规则，生成28位编号，

结果为：C0001A0101201507100123456789



## 系统流水号规则

系统流水号共计30位，生成规则为“5位系统标识+3位模块标识+2位服务器实例序号+8位日期+12位序号”。

系统标识、模块标识、服务器实例序号、日期、序号的说明与统一流水号一样，只是序号长度为12位，通过流水号位数与统一流水号进行区分。



## 接口流水号规则

接口流水号共计39位，生成规则为“5位发起系统标识+3位模块标识+2位服务器实例序号+5位目标系统标识+14位日期时间+10位序号”。系统标识、模块标识、服务器实例序号、序号等说明与统一流水号一样，其余说明如下:

**日期时间：**接口实际的发起日期时间，为YYYYMMDDHHMISS格式的日期时间编码（时间为24小时制）。例如20150810230110。



## 接口服务端查重逻辑

根据该接口交互流水号规范，接口服务端应通过流水号进行交易重复的查重控制处理，查重的规则如下：

（1）不对统一流水号进行查重处理；

（2）在接口层，收到报文立即对接口流水号进行查重处理，如果服务端查找到相同接口流水号的报文，直接返回接口流水号重复的错误即可（考虑到性能可以仅对就近一段时间周期的流水号查重，例如查询最近一天内、或一个小时内的接口流水号）；

（3）在业务处理层，收到报文后应对系统流水号进行查重处理，如果未能查到相同系统流水号的记录，或该系统流水号记录的处理结果为失败，可正常执行处理；如果查询到系统流水号记录的处理结果为处理中，应返回未知状态错误；如果查询到系统流水号记录的处理结果为成功，可根据服务自身设计选择返回方式：

A. 返回交易已处理的失败状态，由调用方负责判断错误和进行处理；

B. 按原交易的结果报文方式返回（支持幂等），调用方沿用正常逻辑处理即可。



## 参考示例

假设系统间（或服务间）调用关系如下图：

![img](hivenet_standard_sequence_v1.0.0.assets/wpsyRlCo3.png) 

**示例1.正常调用**

![img](hivenet_standard_sequence_v1.0.0.assets/wpssOOWyY.png) 

 

**示例2.存在失败重新调用情况**

![img](hivenet_standard_sequence_v1.0.0.assets/wpsm7nIQA.png)

